apiVersion: batch/v1
kind: Job
metadata:
  name: database-migration
  namespace: todo-app
  labels:
    app: backend
    app.kubernetes.io/name: database-migration
    app.kubernetes.io/component: migration
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: database-migration
    spec:
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: migration
          image: todo-chatbot-backend:latest
          imagePullPolicy: IfNotPresent
          command:
            - python
            - -c
            - |
              from app.database import create_db_and_tables
              print('Running database migrations...')
              create_db_and_tables()
              print('Database migrations completed successfully!')
          envFrom:
            - configMapRef:
                name: backend-config
            - secretRef:
                name: backend-secrets
          resources:
            requests:
              cpu: "50m"
              memory: "128Mi"
            limits:
              cpu: "200m"
              memory: "256Mi"
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
